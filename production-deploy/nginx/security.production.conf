# Production Security Configuration for ROKO Network Marketing Site

# Hide Nginx version
server_tokens off;
more_clear_headers Server;

# Security headers
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;
add_header Permissions-Policy "accelerometer=(), camera=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), payment=(), usb=()" always;

# Strict Transport Security (HSTS) - Enable when using HTTPS
# add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

# Content Security Policy - Production settings
add_header Content-Security-Policy "
    default-src 'self';
    script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://unpkg.com https://www.googletagmanager.com https://www.google-analytics.com;
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
    font-src 'self' https://fonts.gstatic.com data:;
    img-src 'self' data: https: blob:;
    connect-src 'self' https://api.roko.network wss://api.roko.network https://www.google-analytics.com;
    frame-src 'none';
    object-src 'none';
    base-uri 'self';
    form-action 'self';
    frame-ancestors 'none';
    upgrade-insecure-requests;
" always;

# CORS headers (adjust origins as needed)
# add_header Access-Control-Allow-Origin "https://marketing.roko.network" always;
# add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
# add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range" always;
# add_header Access-Control-Expose-Headers "Content-Length,Content-Range" always;

# File upload restrictions
client_max_body_size 2m;
client_body_buffer_size 16k;
client_header_buffer_size 1k;
large_client_header_buffers 4 16k;

# Timeouts
client_body_timeout 10;
client_header_timeout 10;
send_timeout 10;
keepalive_timeout 65;

# SSL Configuration (when HTTPS is enabled)
# ssl_protocols TLSv1.2 TLSv1.3;
# ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';
# ssl_prefer_server_ciphers off;
# ssl_session_cache shared:SSL:10m;
# ssl_session_timeout 10m;
# ssl_session_tickets off;
# ssl_stapling on;
# ssl_stapling_verify on;
# ssl_trusted_certificate /path/to/chain.pem;

# DDoS Protection
limit_req_zone $binary_remote_addr zone=general:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=api:10m rate=100r/s;
limit_req_zone $binary_remote_addr zone=static:10m rate=50r/s;
limit_conn_zone $binary_remote_addr zone=addr:10m;

# Request rate limiting
limit_req_status 429;
limit_conn_status 429;

# Custom error page for rate limiting
error_page 429 /429.html;
location = /429.html {
    default_type text/html;
    return 429 '<!DOCTYPE html>
<html>
<head>
    <title>Too Many Requests</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 50px; }
        h1 { color: #e74c3c; }
    </style>
</head>
<body>
    <h1>429 - Too Many Requests</h1>
    <p>You have made too many requests. Please try again later.</p>
</body>
</html>';
}

# Deny access to sensitive files
location ~ /\.(env|git|gitignore|gitlab-ci|travis|htaccess|htpasswd|svn|swp|DS_Store)$ {
    deny all;
    return 404;
}

# Block common exploits
location ~* "(eval\()" { deny all; }
location ~* "(127\.0\.0\.1)" { deny all; }
location ~* "([a-z0-9]{2000,})" { deny all; }
location ~* "(javascript\:)(.*)(\;)" { deny all; }
location ~* "(base64_encode)(.*)(\()" { deny all; }
location ~* "(GLOBALS|REQUEST)(=|\[|%)" { deny all; }
location ~* "(<|%3C).*script.*(>|%3E)" { deny all; }

# Block SQL injections
location ~* "(boot\.ini|etc/passwd|self/environ)" { deny all; }
location ~* "(thumbs?(_editor|open)?|tim(thumb)?)\.php" { deny all; }
location ~* "(\.|20)union(.*)select" { deny all; }
location ~* "union.*.select.*\(" { deny all; }
location ~* "(concat|insert|script|select|union|update)" { deny all; }

# Block file injections
location ~* "[a-zA-Z0-9_]=(\.\.//?)+" { deny all; }
location ~* "[a-zA-Z0-9_]=/([a-z0-9_.]//?)+" { deny all; }

# Security through obscurity - Hide server software versions
fastcgi_hide_header X-Powered-By;
proxy_hide_header X-Powered-By;
proxy_hide_header X-AspNet-Version;
proxy_hide_header X-AspNetMvc-Version;

# Additional security configurations
autoindex off;
if_modified_since off;
etag off;